---
layout: post
title: 自制centos6小系统
date: 2017-06-29 12:00
author: felo
tags: centos
---


# 1.环境准备

```python
[root@CentOS6 ~]# uname -a
Linux CentOS6 2.6.32-431.el6.x86_64 #1 SMP Fri Nov 22 03:15:09 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux
[root@CentOS6 ~]# cat /etc/redhat-release
CentOS release 6.5 (Final)
[root@CentOS6 ~]# fdisk -l
...
# 除了系统盘外，有一块空盘
Disk /dev/sdb: 21.5 GB, 21474836480 bytes
255 heads, 63 sectors/track, 2610 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0x00000000

[root@CentOS6 ~]# mount /dev/cdrom /mnt/
mount: block device /dev/sr0 is write-protected, mounting read-only
# 需要光盘里的一些文件
[root@CentOS6 ~]# ls /mnt/isolinux/
boot.cat  grub.conf   isolinux.bin  memtest     TRANS.TBL     vmlinuz
boot.msg  initrd.img  isolinux.cfg  splash.jpg  vesamenu.c32

```


# 2.制作过程

## 2.1 grub

```python
# 先分区
[root@CentOS6 ~]# fdisk -l /dev/sdb
...
   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1               1          14      112423+  83  Linux
/dev/sdb2              15        2610    20852370   83  Linux

[root@CentOS6 ~]# mkfs.ext4 /dev/sdb1
[root@CentOS6 ~]# mkfs.ext4 /dev/sdb2

[root@CentOS6 ~]# mkdir -p /mylinux/boot
[root@CentOS6 ~]# mkdir -p /mylinux/sysroot
[root@CentOS6 ~]# mount /dev/sdb1 /mylinux/boot/
[root@CentOS6 ~]# mount /dev/sdb2 /mylinux/sysroot/

# 开始制作grub
[root@CentOS6 ~]# grub-install --root-directory=/mylinux /dev/sdb
Probing devices to guess BIOS drives. This may take a long time.
Installation finished. No error reported.
This is the contents of the device map /mylinux/boot/grub/device.map.
Check if this is correct or not. If any of the lines is incorrect,
fix it and re-run the script `grub-install'.

(fd0)   /dev/fd0
(hd0)   /dev/sda
(hd1)   /dev/sdb
[root@CentOS6 ~]# ls /mylinux/boot/
grub  lost+found

```

## 2.2 内核vmlinuz

```python
[root@CentOS6 ~]# cp /mnt/isolinux/vmlinuz /mylinux/boot/
# 搞定
```

## 2.3 initrd

## 2.4 修改grub配置文件

```python
[root@CentOS6 sysroot]# cat /mylinux/boot/grub/grub.conf
default=0
timeout=5
title Mylinux
        root(hd0,0)
        kernel /vmlinuz
        initrd /initrd.img
```

## 2.5 创建根目录

```python
[root@CentOS6 sysroot]# tree
.
├── bin
│   └── bash
├── boot
├── dev
├── etc
│   └── rc.d
├── home
├── lib
├── lib64
├── lost+found
├── proc
├── root
├── sbin
│   └── init
├── sys
├── tmp
├── usr
│   ├── bin
│   └── sbin
└── var
    └── log

# 至少需要两个进程
[root@CentOS6 sysroot]# cp /sbin/init sbin/
[root@CentOS6 sysroot]# cp /bin/bash bin/

# 拷贝 init需要的库
[root@CentOS6 sysroot]# ldd /sbin/init
        linux-vdso.so.1 =>  (0x00007fffe23ff000)
        libnih.so.1 => /lib64/libnih.so.1 (0x00007f97150cf000)
        libnih-dbus.so.1 => /lib64/libnih-dbus.so.1 (0x00007f9714ec5000)
        libdbus-1.so.3 => /lib64/libdbus-1.so.3 (0x00007f9714c83000)
        libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f9714a66000)
        librt.so.1 => /lib64/librt.so.1 (0x00007f971485e000)
        libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007f9714647000)
        libc.so.6 => /lib64/libc.so.6 (0x00007f97142b3000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f9715512000)
[root@CentOS6 sysroot]# cp /lib64/libsepol.so.1 lib64/
[root@CentOS6 sysroot]# cp /lib64/libnih.so.1 lib64/
[root@CentOS6 sysroot]# cp /lib64/libnih-dbus.so.1 lib64/
[root@CentOS6 sysroot]# cp /lib64/libdbus-1.so.3 lib64/
[root@CentOS6 sysroot]# cp /lib64/libpthread.so.0 lib64/
[root@CentOS6 sysroot]# cp /lib64/librt.so.1 lib64/
[root@CentOS6 sysroot]# cp /lib64/libgcc_s.so.1 lib64/
[root@CentOS6 sysroot]# cp /lib64/libc.so.6 lib64/
[root@CentOS6 sysroot]# cp /lib64/ld-linux-x86-64.so.2 lib64/
[root@CentOS6 sysroot]# ls lib64/
ld-linux-x86-64.so.2  libdbus-1.so.3  libnih-dbus.so.1  libpthread.so.0  libsepol.so.1
libc.so.6             libgcc_s.so.1   libnih.so.1       librt.so.1

# 拷贝 bash 需要的库
[root@CentOS6 sysroot]# ldd /bin/bash
        linux-vdso.so.1 =>  (0x00007fff11fb5000)
        libtinfo.so.5 => /lib64/libtinfo.so.5 (0x00007fc749f8e000)
        libdl.so.2 => /lib64/libdl.so.2 (0x00007fc749d8a000)
        libc.so.6 => /lib64/libc.so.6 (0x00007fc7499f5000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fc74a1b4000)
[root@CentOS6 sysroot]#
[root@CentOS6 sysroot]#
[root@CentOS6 sysroot]# cp /lib64/libtinfo.so.5 lib64/
[root@CentOS6 sysroot]# cp /lib64/libdl.so.2 lib64/
[root@CentOS6 sysroot]# cp  /lib64/libc.so.6 lib64/
cp: overwrite `lib64/libc.so.6'?
[root@CentOS6 sysroot]# cp /lib64/ld-linux-x86-64.so.2 lib64/
cp: overwrite `lib64/ld-linux-x86-64.so.2'?
[root@CentOS6 sysroot]#

# 用chroot测试一下
[root@CentOS6 sysroot]# chroot /mylinux/sysroot/
bash-4.1# pwd
/
bash-4.1# ls
bash: ls: command not found
bash-4.1# exit
exit
[root@CentOS6 sysroot]#

```

## 2.6 配置inittab文件

```python
[root@CentOS6 sysroot]# vi etc/inittab
[root@CentOS6 sysroot]# cat etc/inittab
id:3:initdefault:
si::sysinit:/etc/rc.d/rc.sysinit
[root@CentOS6 sysroot]# vi etc/rc.d/rc.sysinit
[root@CentOS6 sysroot]# cat etc/rc.d/rc.sysinit
#!/bin/bash

echo -e "\tWelcome to MyLinux."
/bin/bash
[root@CentOS6 sysroot]# chmod +x etc/rc.d/rc.sysinit
[root@CentOS6 sysroot]# ls -l etc/rc.d/rc.sysinit
-rwxr-xr-x 1 root root 55 Jun 30 05:57 etc/rc.d/rc.sysinit
```

## 2.7 测试

新建虚拟机，使用sdb这个硬盘，启动
失败了，查找原因中。。。。。

# 3.其他
