---
layout: post
title: GPFS安装部署测试
date: 2017-09-26 21:00
author: felo
tags: centos gpfs
---


# 0.环境准备和规划

## 拓扑图

![](/images/gpfs_install_test/gpfs_top.png)

## 规划表

ID | hostname | IP Address |   disk           | manager
---|----------|------------|------------------|---------
1  |    c01   | 10.10.1.173| sda:20GB;sdb:20GB|quorum-manager
2  |    c02   | 10.10.1.174| sda:20GB;sdb:20GB|quorum-manager
3  |    c03   | 10.10.1.175| sda:20GB;sdb:20GB|quorum


name      |  value    
----------|-------------------
集群名称  | 3NodeCluster
主节点    | c01
远程命令  | ssh，scp
nsd配置文件| /etc/gpfs/3node_nsd_input



## 内核
```bash
[root@c01 ~]# uname -r
2.6.32-431.el6.x86_64
[root@c01 ~]# cat /etc/redhat-release
CentOS release 6.5 (Final)
```


# 1.安装部署

在三个节点安装下面的内容，这里是c01,c02,c03

## 关闭SELINUX

```
[root@c01 ~]# sed -i "s#SELINUX=enforcing#SELINUX=disabled#g" /etc/selinux/config
[root@c01 ~]# cat /etc/selinux/config |grep SELINUX=
# SELINUX= can take one of these three values:
SELINUX=disabled

```


## 修改hosts表

```
[root@c01 ~]# echo "10.10.1.173 c01" >> /etc/hosts
[root@c01 ~]# echo "10.10.1.174 c02" >> /etc/hosts
[root@c01 ~]# echo "10.10.1.175 c03" >> /etc/hosts
[root@c01 ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.10.1.173 c01
10.10.1.174 c02
10.10.1.175 c03
```

## 准备安装包

```bash
[root@c01 3.5]# yum -y install unzip
[root@c01 3.5]# yum -y groupinstall "Desktop"
[root@c01 3.5]# unzip gpfs_install-3.5.zip
```
在图形界面下执行解压后的压缩包gpfs_install-3.5.0-0_x86_64，接受许可。

```bash
[root@c01 ~]# cd /usr/lpp/mmfs/3.5/
[root@c01 3.5]# ls -l
total 12952
-rw-r--r-- 1 root root 12405953 Jan 19  2013 gpfs.base-3.5.0-3.x86_64.rpm
-rw-r--r-- 1 root root   230114 Jan 19  2013 gpfs.docs-3.5.0-3.noarch.rpm
-rw-r--r-- 1 root root   509477 Jan 19  2013 gpfs.gpl-3.5.0-3.noarch.rpm
-rw-r--r-- 1 root root    99638 Jan 19  2013 gpfs.msg.en_US-3.5.0-3.noarch.rpm
drwxr-xr-x 2 root root     4096 Sep 27 06:31 license
-rw-r--r-- 1 root root       39 Sep 27 06:31 status.dat
[root@c01 ~]# yum -y install ksh
...
[root@c01 3.5]# rpm -ivh gpfs.base-3.5.0-3.x86_64.rpm
Preparing...                ########################################### [100%]
   1:gpfs.base              ########################################### [100%]
[root@c01 3.5]# rpm -ivh gpfs.docs-3.5.0-3.noarch.rpm
Preparing...                ########################################### [100%]
   1:gpfs.docs              ########################################### [100%]
[root@c01 3.5]# rpm -ivh gpfs.gpl-3.5.0-3.noarch.rpm
Preparing...                ########################################### [100%]
   1:gpfs.gpl               ########################################### [100%]
[root@c01 3.5]# rpm -ivh gpfs.msg.en_US-3.5.0-3.noarch.rpm
Preparing...                ########################################### [100%]
   1:gpfs.msg.en_US         ########################################### [100%]
```
## 编译和安装GPL层二进制文件

```bash
[root@c02 ~]# cd /usr/lpp/mmfs/src/
[root@c01 src]# yum -y install cpp gcc gcc-c++
...

[root@c01 src]# make LINUX_DISTRIBUTION=REDHAT_AS_LINUX Autoconfig World InstallImages \
2>/tmp/make_err 1>/tmp/make_out

# 验证
[root@c01 src]# ls -al /lib/modules/2.6.32-696.10.2.el6.x86_64/extra/
total 6016
drwxr-xr-x 2 root root    4096 Sep 27 07:08 .
drwxr-xr-x 7 root root    4096 Sep 27 07:08 ..
-rw-r--r-- 1 root root 2894349 Sep 27 07:08 mmfs26.ko
-rw-r--r-- 1 root root 2547296 Sep 27 07:08 mmfslinux.ko
-rw-r--r-- 1 root root  708128 Sep 27 07:08 tracedev.ko

```

## 配置ssh免密码

在每个节点上都要运行，比较繁琐。

```bash

# 创建密钥对
[root@c01 ~]# ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
6b:e2:e6:ac:9f:9e:86:5b:74:20:c3:69:76:0d:8d:9a root@c01
The key's randomart image is:
+--[ RSA 2048]----+
|      .o         |
|   . ..o.        |
|    Boo .        |
|   oE+ .         |
|      . S        |
|     . . .       |
|     .o o        |
|    .+o=         |
|    oOO          |
+-----------------+

# 出现一对秘钥对
[root@c01 ~]# cat .ssh/id_rsa
id_rsa      id_rsa.pub

# 把公钥复制到authorized_keys下
[root@c01 .ssh]# ssh-copy-id c01
The authenticity of host 'c01 (10.10.1.173)' can't be established.
RSA key fingerprint is 73:57:3c:94:e3:c8:62:2b:9c:0a:bc:87:a5:07:92:14.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'c01,10.10.1.173' (RSA) to the list of known hosts.
root@c01's password:
Now try logging into the machine, with "ssh 'c01'", and check in:

  .ssh/authorized_keys

to make sure we haven't added extra keys that you weren't expecting.

# 第一次都会有下面这么一串：
The authenticity of host 'c01 (10.10.1.173)' can't be established.
RSA key fingerprint is 73:57:3c:94:e3:c8:62:2b:9c:0a:bc:87:a5:07:92:14.
Are you sure you want to continue connecting (yes/no)? 
如果不想不想这么麻烦，可以在配置文件里删除一下，StrictHostKeyChecking改为no即可：
[root@c01 .ssh]# cat /etc/ssh/ssh_config  |grep HostKey
StrictHostKeyChecking no

[root@c01 ~]# ssh-copy-id c02
Warning: Permanently added 'c02,10.10.1.174' (RSA) to the list of known hosts.
root@c02's password:
Now try logging into the machine, with "ssh 'c02'", and check in:

  .ssh/authorized_keys

to make sure we haven't added extra keys that you weren't expecting.

[root@c01 ~]# ssh-copy-id c03
Warning: Permanently added 'c03,10.10.1.175' (RSA) to the list of known hosts.
root@c03's password:
Now try logging into the machine, with "ssh 'c03'", and check in:

  .ssh/authorized_keys

to make sure we haven't added extra keys that you weren't expecting.

# 测试一下
[root@c01 ~]# for i in 1 2 3;do ssh c0$i date;done
Fri Sep 29 05:19:35 CST 2017
Fri Sep 29 05:19:36 CST 2017
Fri Sep 29 05:19:36 CST 2017

```

但是，这么弄得话，确实比较繁琐，特别是当节点更多的情况下：
比较好的解决办法是可以使用一个nfs，手动将authorized_keys文件做好后，复制到每个节点
的.ssh目录下面即可，这样不用每次都使用ssh-copy-id命令。

```bash
...

```


# 2.测试
在一个节点中执行即可，这里是c01。


## 创建3节点GPFS集群


```bash
[root@c01 mmfs]# ./bin/mmcrcluster -N "c01:manager-quorum,c02:manager-quorum,c03:quorum" \
 -p c01 -r /usr/bin/ssh -R /usr/bin/scp -C 3NodeCluster
Fri Sep 29 05:42:52 CST 2017: mmcrcluster: Processing node c01
Fri Sep 29 05:42:52 CST 2017: mmcrcluster: Processing node c02
Fri Sep 29 05:42:55 CST 2017: mmcrcluster: Processing node c03
mmcrcluster: Command successfully completed
mmcrcluster: Warning: Not all nodes have proper GPFS license designations.
    Use the mmchlicense command to designate licenses as needed.
mmcrcluster: Propagating the cluster configuration data to all
  affected nodes.  This is an asynchronous process.
[root@c01 mmfs]# ./bin/mmlscluster

===============================================================================
| Warning:                                                                    |
|   This cluster contains nodes that do not have a proper GPFS license        |
|   designation.  This violates the terms of the GPFS licensing agreement.    |
|   Use the mmchlicense command and assign the appropriate GPFS licenses      |
|   to each of the nodes in the cluster.  For more information about GPFS     |
|   license designation, see the Concepts, Planning, and Installation Guide.  |
===============================================================================


GPFS cluster information
========================
  GPFS cluster name:         3NodeCluster.c01
  GPFS cluster id:           5187696956017568988
  GPFS UID domain:           3NodeCluster.c01
  Remote shell command:      /usr/bin/ssh
  Remote file copy command:  /usr/bin/scp

GPFS cluster configuration servers:
-----------------------------------
  Primary server:    c01
  Secondary server:  (none)

 Node  Daemon node name  IP address   Admin node name  Designation
-------------------------------------------------------------------
   1   c01               10.10.1.173  c01              quorum-manager
   2   c02               10.10.1.174  c02              quorum-manager
   3   c03               10.10.1.175  c03              quorum

# 接受许可

[root@c01 mmfs]# ./bin/mmchlicense server --accept -N c01,c02,c03

The following nodes will be designated as possessing GPFS server licenses:
        c01
        c02
        c03
mmchlicense: Command successfully completed
mmchlicense: Propagating the cluster configuration data to all
  affected nodes.  This is an asynchronous process.

[root@c01 mmfs]# ./bin/mmlslicense -L
 Node name                    Required license   Designated license
-------------------------------------------------------------------
c01                                server            server
c02                                server            server
c03                                server            server

 Summary information
---------------------
Number of nodes defined in the cluster:                          3
Number of nodes with server license designation:                 3
Number of nodes with client license designation:                 0
Number of nodes still requiring server license designation:      0
Number of nodes still requiring client license designation:      0


```

## 创建NSD（网络共享磁盘）

```bash
[root@c01 mmfs]# mkdir -p /etc/gpfs
[root@c01 mmfs]# echo "/dev/sdb:c01::dataAndMetadata:3001:c01nsd01" >>/etc/gpfs/3node_nsd_input
[root@c01 mmfs]# echo "/dev/sdb:c02::dataAndMetadata:3002:c02nsd01" >>/etc/gpfs/3node_nsd_input
[root@c01 mmfs]# echo "/dev/sdb:c03::dataAndMetadata:3003:c03nsd01" >>/etc/gpfs/3node_nsd_input
[root@c01 mmfs]# cat /etc/gpfs/3node_nsd_input
/dev/sdb:c01::dataAndMetadata:3001:c01nsd01
/dev/sdb:c02::dataAndMetadata:3002:c02nsd01
/dev/sdb:c03::dataAndMetadata:3003:c03nsd01
[root@c01 mmfs]# ./bin/mmcrnsd -F /etc/gpfs/3node_nsd_input -v yes
mmcrnsd: Processing disk sdb
mmcrnsd: Processing disk sdb
mmcrnsd: Processing disk sdb
mmcrnsd: Propagating the cluster configuration data to all
  affected nodes.  This is an asynchronous process.
[root@c01 ~]# cd
[root@c01 ~]# cat /etc/gpfs/3node_nsd_input
# /dev/sdb:c01::dataAndMetadata:3001:c01nsd01
c01nsd01:::dataAndMetadata:3001::system
# /dev/sdb:c02::dataAndMetadata:3002:c02nsd01
c02nsd01:::dataAndMetadata:3002::system
# /dev/sdb:c03::dataAndMetadata:3003:c03nsd01
c03nsd01:::dataAndMetadata:3003::system

[root@c01 ~]# mmlsnsd

 File system   Disk name    NSD servers
---------------------------------------------------------------------------
 (free disk)   c01nsd01     c01
 (free disk)   c02nsd01     c02
 (free disk)   c03nsd01     c03


```


## 创建GPFS文件系统

```bash
[root@c01 ~]# mmcrfs /gpfs1 /dev/gpfs1 -F /etc/gpfs/3node_nsd_input  -B 256k \
 -n 80 -v no -R 2 -M 2 -r 2 -m 2 -A yes -Q no
mmcommon: tsctl command cannot be executed.  Either none of the
  nodes in the cluster are reachable, or GPFS is down on all of the nodes.
mmcrfs: Command failed.  Examine previous error messages to determine cause.

# 报错，cluster没启动

[root@c01 ~]# mmgetstate -aLs

 Node number  Node name       Quorum  Nodes up  Total nodes  GPFS state  Remarks   
------------------------------------------------------------------------------------
       1      c01                0        0          3       down        quorum node
       2      c02                0        0          3       unknown     quorum node
       3      c03                0        0          3       unknown     quorum node

 Summary information
---------------------
mmgetstate: Information cannot be displayed.  Either none of the
  nodes in the cluster are reachable, or GPFS is down on all of the nodes.

# 查看并关闭所有的节点的selinux和iptables
[root@c01 ~]# getenforce
Disabled
[root@c01 ~]# service iptables stop

# 重新启动集群
[root@c01 ~]# mmstartup -a
Fri Sep 29 06:11:32 CST 2017: mmstartup: Starting GPFS ...
[root@c01 ~]#
[root@c01 ~]# mmgetstate -aLs

# 重新创建文件系统
[root@c01 ~]# mmcrfs /gpfs1 /dev/gpfs1 -F /etc/gpfs/3node_nsd_input \
 -B 256k -n 80 -v no -R 2 -M 2 -r 2 -m 2 -A yes -Q no

The following disks of gpfs1 will be formatted on node c01:
    c01nsd01: size 20971520 KB
    c02nsd01: size 20971520 KB
    c03nsd01: size 20971520 KB
Formatting file system ...
Disks up to size 257 GB can be added to storage pool system.
Creating Inode File
Creating Allocation Maps
Creating Log Files
Clearing Inode Allocation Map
Clearing Block Allocation Map
Formatting Allocation Map for storage pool system
Completed creation of file system /dev/gpfs1.
mmcrfs: Propagating the cluster configuration data to all
  affected nodes.  This is an asynchronous process.

# 挂载所有节点
[root@c01 ~]# mmmount gpfs1 -a
Fri Sep 29 06:15:33 CST 2017: mmmount: Mounting file systems ...
[root@c01 ~]# df -h
Filesystem                  Size  Used Avail Use% Mounted on
/dev/mapper/vg_c01-lv_root   18G  1.9G   15G  12% /
tmpfs                       491M     0  491M   0% /dev/shm
/dev/sda1                   477M   49M  404M  11% /boot
/dev/gpfs1                   60G  754M   60G   2% /gpfs1

```

## 测试

```bash
# 在c03上写文件
[root@c03 ~]# df -h
Filesystem                  Size  Used Avail Use% Mounted on
/dev/mapper/vg_c01-lv_root   18G  2.0G   15G  12% /
tmpfs                       491M     0  491M   0% /dev/shm
/dev/sda1                   477M   49M  404M  11% /boot
/dev/gpfs1                   60G   16G   45G  26% /gpfs1
[root@c03 ~]# cd /gpfs1/
[root@c03 gpfs1]# date >> test1.txt

# c01上查看
[root@c01 ~]# cat /gpfs1/test1.txt
Fri Sep 29 06:16:36 CST 2017

```
