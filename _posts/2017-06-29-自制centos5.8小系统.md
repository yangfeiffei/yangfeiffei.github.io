---
layout: post
title: 自制centos5.8小系统
date: 2017-06-29 12:00
author: felo
tags: centos
---


# 1.环境准备

准备一个centos5.8的虚拟机，内存1G或者更多，硬盘两块，一块作为本地操作系统，另一块
为新系统准备。

```bash
[root@centos501 ~]# uname -a
Linux centos501 2.6.18-308.el5 #1 SMP Tue Feb 21 20:06:06 EST 2012 x86_64 x86_64
x86_64 GNU/Linux
[root@centos501 ~]# cat /etc/redhat-release
CentOS release 5.8 (Final)
# 多准备一个磁盘
[root@centos501 ~]# fdisk -l

Disk /dev/sda: 21.4 GB, 21474836480 bytes
255 heads, 63 sectors/track, 2610 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *           1          13      104391   83  Linux
/dev/sda2              14        2610    20860402+  83  Linux

Disk /dev/sdb: 10.7 GB, 10737418240 bytes
255 heads, 63 sectors/track, 1305 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

Disk /dev/sdb doesn't contain a valid partition table
```


# 2.制作过程

主要制作过程如下图所示：

![](/images/自制centos5.8小系统/制作主要过程图.png)

## 2.1 grub

```bash
# 先分区
[root@centos501 ~]# fdisk -l /dev/sdb

Disk /dev/sdb: 10.7 GB, 10737418240 bytes
255 heads, 63 sectors/track, 1305 cylinders
Units = cylinders of 16065 * 512 = 8225280 bytes

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1               1          13      104391   83  Linux
/dev/sdb2              14        1305    10377990   83  Linux
[root@centos501 ~]# mkfs.ext3 /dev/sdb1
[root@centos501 ~]# mkfs.ext3 /dev/sdb2
[root@centos501 ~]# mkdir /mylinux/{boot,sysroot} -pv
mkdir: created directory '/mylinux'
mkdir: created directory '/mylinux/boot'
mkdir: created directory '/mylinux/sysroot'
[root@centos501 ~]# mount /dev/sdb1 /mylinux/boot/
[root@centos501 ~]# mount /dev/sdb2 /mylinux/sysroot/

# 开始制作grub
[root@centos501 ~]# grub-install --root-directory=/mylinux /dev/sdb
Probing devices to guess BIOS drives. This may take a long time.
Installation finished. No error reported.
This is the contents of the device map /mylinux/boot/grub/device.map.
Check if this is correct or not. If any of the lines is incorrect,
fix it and re-run the script 'grub-install'.

(fd0)   /dev/fd0
(hd0)   /dev/sda
(hd1)   /dev/sdb
[root@centos501 ~]# ls -l /mylinux/boot/
total 14
drwxr-xr-x 2 root root  1024 Jul  1 19:30 grub
drwx------ 2 root root 12288 Jul  1 19:28 lost+found
```

## 2.2 内核vmlinuz

```bash
[root@centos501 ~]# cp /boot/vmlinuz-2.6.18-308.el5 /mylinux/boot/vmlinuz
```

## 2.3 initrd

```bash
[root@centos501 ~]# mkdir /tmp/test
[root@centos501 ~]# cd /tmp/test/
[root@centos501 test]# zcat /boot/initrd-2.6.18-308.el5.img |cpio -id
14113 blocks
[root@centos501 test]# ls
bin  dev  etc  init  lib  proc  sbin  sys  sysroot
# 修改一下根目录启动位置，这里现有系统和新系统的位置是一样的，因此
# 不需要进行修改
[root@centos501 test]# cat init |grep /dev/sda2
mkrootdev -t ext3 -o defaults,ro /dev/sda2
# 重新再压缩好
[root@centos501 test]# find . | cpio -H newc --quiet -o |gzip -9 >
/mylinux/boot/initrd.img
[root@centos501 test]# ls /mylinux/boot/
grub  initrd.img  lost+found  vmlinuz

```



## 2.4 修改grub配置文件

```bash
[root@centos501 ~]# vim /mylinux/boot/grub/grub.conf
[root@centos501 ~]# cat /mylinux/boot/grub/grub.conf
default=0
timeout=5
title Mylinux
        root (hd0,0)
        kernel /vmlinuz
        initrd /initrd.img
```

## 2.5 创建根目录

```python
[root@centos501 sysroot]# mkdir bin boot dev etc/rc.d home lib lib64 proc root
sbin sys tmp usr/{bin,sbin} var/log -p
[root@centos501 sysroot]# tree
.
|-- bin
|-- boot
|-- dev
|-- etc
|   `-- rc.d
|-- home
|-- lib
|-- lib64
|-- lost+found
|-- proc
|-- root
|-- sbin
|-- sys
|-- tmp
|-- usr
|   |-- bin
|   `-- sbin
`-- var
    `-- log

19 directories, 0 files`


# 至少需要两个进程
[root@centos501 sysroot]# cp /sbin/init sbin/
[root@centos501 sysroot]# cp /bin/bash bin/

# 拷贝 init需要的库
[root@centos501 sysroot]# ldd /sbin/init
        linux-vdso.so.1 =>  (0x00007ffffebfd000)
        libsepol.so.1 => /lib64/libsepol.so.1 (0x00002b274f3b1000)
        libselinux.so.1 => /lib64/libselinux.so.1 (0x00002b274f5f7000)
        libc.so.6 => /lib64/libc.so.6 (0x00002b274f80f000)
        libdl.so.2 => /lib64/libdl.so.2 (0x00002b274fb68000)
        /lib64/ld-linux-x86-64.so.2 (0x00002b274f193000)
[root@centos501 sysroot]# cp /lib64/libsepol.so.1 lib64/
[root@centos501 sysroot]# cp /lib64/libselinux.so.1 lib64/
[root@centos501 sysroot]# cp /lib64/libc.so.6 lib64/
[root@centos501 sysroot]# cp /lib64/libdl.so.2 lib64/
[root@centos501 sysroot]# cp /lib64/ld-linux-x86-64.so.2 lib64/

# 拷贝 bash 需要的库
[root@centos501 sysroot]# ldd /bin/bash
        linux-vdso.so.1 =>  (0x00007fff9f9fd000)
        libtermcap.so.2 => /lib64/libtermcap.so.2 (0x00002ba35562a000)
        libdl.so.2 => /lib64/libdl.so.2 (0x00002ba35582d000)
        libc.so.6 => /lib64/libc.so.6 (0x00002ba355a31000)
        /lib64/ld-linux-x86-64.so.2 (0x00002ba35540c000)
[root@centos501 sysroot]#
[root@centos501 sysroot]# cp /lib64/libtermcap.so.2 lib64/
[root@centos501 sysroot]# cp /lib64/libdl.so.2 lib64/
cp: overwrite 'lib64/libdl.so.2'?
[root@centos501 sysroot]# cp /lib64/libc.so.6 lib64/
cp: overwrite 'lib64/libc.so.6'?
[root@centos501 sysroot]# cp /lib64/ld-linux-x86-64.so.2 lib64/
cp: overwrite 'lib64/ld-linux-x86-64.so.2'?

# 用chroot测试一下
[root@centos501 sysroot]# chroot /mylinux/sysroot/
bash-3.2# pwd
/
bash-3.2# ls
bash: ls: command not found
bash-3.2# exit
exit
[root@centos501 sysroot]#

```

## 2.6 配置inittab文件

```bash
[root@centos501 sysroot]# vim etc/inittab
[root@centos501 sysroot]# cat etc/inittab
id:3:initdefault:
si::sysinit:/etc/rc.d/rc.sysinit
[root@centos501 sysroot]# vim etc/rc.d/rc.sysinit
[root@centos501 sysroot]# cat etc/rc.d/rc.sysinit
#!/bin/bash
echo -e "\t Welcome to Mylinux..."
/bin/bash
[root@centos501 sysroot]# chmod +x etc/rc.d/rc.sysinit
```

## 2.7 测试

新建虚拟机，使用sdb这个硬盘，启动

![](/images/自制centos5.8小系统/测试系统启动0.png)
![](/images/自制centos5.8小系统/测试系统启动1.png)

# 3.其他






